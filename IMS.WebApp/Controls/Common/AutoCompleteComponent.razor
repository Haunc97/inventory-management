<div class="form-group position-relative">
    <label for="search" class="form-label text-muted small text-uppercase fw-bold">@Label</label>
    <div class="input-group">
        <input type="text"
               class="form-control"
               @bind-value="userInput"
               @bind-value:event="oninput"
               @onkeyup="OnPressKeys"
               placeholder="Type to search..." />
    </div>

    @if (searchResults != null && searchResults.Any())
    {
        <div class="search-result shadow-md rounded border-0 mt-1">
            <ul class="list-group list-group-flush">
                @{
                    var itemIndex = 0;
                    foreach (var item in searchResults)
                    {
                        <li @key="item.Id"
                            @onclick="@(() => OnSelectItem(item))"
                            class="list-group-item list-group-item-action @(currentIndex == itemIndex ? "active" : "")"
                            style="cursor:pointer">
                            @item.Name
                        </li>
                        itemIndex++;
                    }
                }
            </ul>
        </div>
    }
</div>

@code {
    [Parameter]
    public string Label { get; set; } = string.Empty;

    [Parameter]
    public Func<string, Task<List<ItemViewModel>?>> SearchFunction { get; set; } = null!;

    [Parameter]
    public EventCallback<ItemViewModel> OnItemSelected { get; set; }

    public ItemViewModel? selectedItem = null;
    public List<ItemViewModel>? searchResults = null;

    private ItemViewModel? currentItem = null;
    private int currentIndex = -1;

    private string _userInput = string.Empty;
    public string userInput
    {
        get => _userInput;
        set
        {
            _userInput = value;

            if (!string.IsNullOrWhiteSpace(_userInput) && SearchFunction != null)
            {
                if (selectedItem?.Name != _userInput)
                {
                    ViewItemsAsync();
                }
            }
            else
            {
                this.ClearCurrentItem();
            }
        }
    }

    private async Task ViewItemsAsync()
    {
        if (SearchFunction != null)
        {
            searchResults = await SearchFunction(_userInput);
            this.selectedItem = null;

            StateHasChanged();
        }
    }

    private void OnSelectItem(ItemViewModel item)
    {
        this.ClearCurrentItem();

        if (item != null)
        {
            this.selectedItem = item;
            this.userInput = item.Name;
            this.OnItemSelected.InvokeAsync(item);
        }
    }

    private void ClearCurrentItem()
    {
        this.searchResults = null;
        this.currentIndex = -1;
        this.currentItem = null;
    }

    private void OnPressKeys(KeyboardEventArgs e)
    {
        if ((e.Code == "ArrowDown" || e.Code == "ArrowUp") && searchResults != null && searchResults.Any())
        {
            if (e.Code == "ArrowDown" && currentIndex < searchResults.Count - 1)
            {
                currentItem = searchResults[++currentIndex];
            }
            else if (e.Code == "ArrowUp")
            {
                if (currentIndex > 0)
                    currentItem = searchResults[--currentIndex];
                else
                {
                    currentItem = null;
                    currentIndex = -1;
                }
            }
        }
        else if (e.Code == "Enter" || e.Code == "NumpadEnter")
        {
            OnSelectItem(currentItem);
        }
    }

    public class ItemViewModel
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
    }
}